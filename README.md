# Тестирование API Moonraker

Этот набор скриптов предназначен для тестирования работоспособности API Moonraker для 3D-принтеров с Klipper.

## Требования

- Python 3.6 или выше
- Установленные зависимости из файла `requirements.txt`

## Установка

1. Клонируйте или скачайте этот репозиторий
2. Установите зависимости:

```bash
pip install -r requirements.txt
```

## Настройка

Перед запуском при необходимости отредактируйте конфигурацию в скриптах, указав:

- IP-адрес вашего сервера Moonraker
- Порт Moonraker (по умолчанию 7125)

По умолчанию скрипты настроены на адрес `http://192.168.10.14:7125`.

## Веб-интерфейс

Проект включает веб-интерфейс на Flask для управления принтером через браузер. Веб-интерфейс доступен по адресу `http://localhost:5000` после запуска.

Для запуска веб-интерфейса выполните:

```bash
python backend/api/web_interface.py
```

Или используйте один из стартовых скриптов:
- `start_tools.bat` (Windows)
- `start_tools.sh` (Linux/macOS)

Веб-интерфейс включает:
- Панель управления принтером
- Отображение текущего состояния принтера
- Управление температурой экструдера и стола
- Управление перемещением осей
- Консоль для отправки G-code команд

## Доступные скрипты

### 1. Тест API (test_moonraker_api.py)

Выполняет набор тестов для проверки базовой работоспособности API Moonraker.

```bash
python backend/services/test_moonraker_api.py
```

#### Тесты

1. **Информация о сервере**: Проверяет, что сервер Moonraker работает и возвращает информацию о состоянии Klippy.
2. **Информация о принтере**: Получает подробную информацию о принтере.
3. **Объекты принтера**: Запрашивает статус компонентов принтера (webhooks, virtual_sdcard, print_stats).
4. **WebSocket**: Проверяет возможность установки WebSocket-соединения и получения данных через него.

### 2. Мониторинг принтера (monitor_printer.py)

Постоянно отслеживает состояние принтера, отображая подробную информацию о текущем состоянии печати.

```bash
python backend/services/monitor_printer.py [опции]
```

#### Опции

- `--host HOST` - IP-адрес Moonraker (по умолчанию: 192.168.10.14)
- `--port PORT` - порт Moonraker (по умолчанию: 7125)
- `--interval INTERVAL` - интервал проверки в секундах (по умолчанию: 5)
- `--count COUNT` - ограничение количества проверок (по умолчанию: бесконечно)

#### Отображаемая информация

- Состояние Klipper и Moonraker
- Текущие температуры экструдера и стола
- Состояние печати (ожидание, печать, пауза, ошибка)
- Прогресс печати (если печать активна)
- Расчетное оставшееся время и ожидаемое время завершения
- Длительность текущей печати
- Скорость печати

### 3. WebSocket слушатель (websocket_listener.py)

Подключается к WebSocket API Moonraker и в реальном времени получает и отображает уведомления о событиях принтера.

```bash
python backend/services/websocket_listener.py [опции]
```

#### Опции

- `--host HOST` - IP-адрес Moonraker (по умолчанию: 192.168.10.14)
- `--port PORT` - порт Moonraker (по умолчанию: 7125)
- `--timeout TIMEOUT` - время ожидания готовности Klippy в секундах (по умолчанию: 30)

#### Функциональность

- Подключение к WebSocket API Moonraker
- Ожидание готовности Klippy
- Подписка на обновления объектов принтера
- Получение и отображение в реальном времени:
  - Изменений состояния печати
  - Изменений температуры
  - Перемещений печатающей головки
  - Прогресса печати
  - G-code ответов от принтера
  - Событий Klippy (подключение, отключение, ошибки)

### 4. Отправка G-code команд (send_gcode.py)

Позволяет отправлять G-code команды на принтер через API Moonraker как в интерактивном режиме, так и в режиме одиночной команды.

```bash
python backend/services/send_gcode.py [опции]
```

#### Опции

- `--host HOST` - IP-адрес Moonraker (по умолчанию: 192.168.10.14)
- `--port PORT` - порт Moonraker (по умолчанию: 7125)
- `--gcode GCODE` - G-code команда для отправки (если не указана, запускается интерактивный режим)
- `--method {http,jsonrpc}` - метод API для отправки (по умолчанию: http)

#### Возможности

- Отправка одиночных G-code команд через аргументы командной строки
- Интерактивный режим с выбором из предопределенных команд
- Ручной ввод любых G-code команд
- Поддержка отправки как через обычное HTTP API, так и через JSON-RPC
- Проверка готовности Klippy перед отправкой команд

### 5. Интерактивный инструмент (moonraker_tool.py)

Полнофункциональный интерактивный инструмент с текстовым интерфейсом для комплексного управления принтером через API Moonraker.

```bash
python backend/services/moonraker_tool.py [опции]
```

#### Опции

- `--host HOST` - IP-адрес Moonraker (по умолчанию: 192.168.10.14)
- `--port PORT` - порт Moonraker (по умолчанию: 7125)

#### Функциональность

- Управление принтером:
  - Отображение статуса принтера и текущих температур
  - Отправка G-code команд
  - Управление нагревателями (стол и экструдер)
  - Перемещение осей
  - Перезагрузка Klipper (хост и прошивка)
  - Аварийная остановка
- Файловый менеджер:
  - Просмотр файлов на принтере
  - Навигация по директориям
- Проверка состояния сервера

## Структура проекта

```
.
├── backend/
│   ├── api/              # Веб-интерфейс (Flask)
│   ├── services/         # Скрипты для работы с API
│   ├── models/           # Модели данных (пустая директория)
│   └── utils/            # Вспомогательные функции (пустая директория)
├── frontend/
│   ├── static/           # Статические файлы (CSS, JS, изображения)
│   │   ├── css/          # Таблицы стилей
│   │   ├── js/           # JavaScript файлы
│   │   └── images/       # Изображения
│   └── templates/        # HTML шаблоны
├── shared/               # Общие ресурсы (пустая директория)
├── requirements.txt      # Зависимости Python
├── start_tools.bat       # Стартовый скрипт для Windows
├── start_tools.sh        # Стартовый скрипт для Linux/macOS
└── README.md             # Этот файл
```

## Вывод

Результаты выводятся в консоль с цветовым форматированием для лучшей читаемости.